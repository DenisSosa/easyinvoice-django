{% extends 'facturacion/base.html' %}

{% block title %}Dashboard - Sistema de Facturación{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        background: white;
        border-radius: 16px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        border: 3px solid #06b6d4;
        box-shadow: 0 4px 20px rgba(6, 182, 212, 0.1);
    }

    .stats-card {
        position: relative;
        overflow: hidden;
        border: 2px solid #06b6d4 !important;
    }

    .stats-card h2 {
        font-size: 2.5rem;
        font-weight: 700;
    }

    .stats-card p {
        font-size: 0.95rem;
        letter-spacing: 0.5px;
    }

    .quick-action-btn {
        padding: 1.5rem;
        border-radius: 16px;
        transition: all 0.3s ease;
        border: none;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .quick-action-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .quick-action-btn i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    .card-modern {
        border-radius: 16px;
        border: 2px solid #06b6d4;
        box-shadow: 0 4px 20px rgba(6, 182, 212, 0.1);
        overflow: hidden;
    }

    .card-modern .card-header {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        padding: 1.5rem;
        border: none;
    }

    .table-modern {
        margin: 0;
    }

    .table-modern thead {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    }

    .table-modern tbody tr {
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s ease;
    }

    .table-modern tbody tr:hover {
        background: #f8feff;
        transform: scale(1.01);
    }

    .client-item {
        padding: 1.25rem;
        border-radius: 12px;
        background: white;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        border: 2px solid #e0f2fe;
    }

    .client-item:hover {
        background: #f0fdfa;
        border-color: #06b6d4;
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.15);
        transform: translateX(5px);
    }

    .badge-modern {
        padding: 0.6rem 1.2rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .estado-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 4px 20px rgba(6, 182, 212, 0.1);
        transition: all 0.3s ease;
        border: 2px solid #06b6d4;
    }

    .estado-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(6, 182, 212, 0.2);
        border-color: #0891b2;
    }

    .estado-card h3 {
        font-size: 2.5rem;
        font-weight: 700;
        color: #06b6d4;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Encabezado Mejorado -->
<div class="dashboard-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="fw-bold mb-2" style="font-size: 2.5rem; color: #0f172a;">
                <i class="fas fa-chart-line" style="color: #06b6d4;"></i> Dashboard
            </h1>
            <p class="text-muted mb-0" style="font-size: 1.1rem;">
                Vista general del sistema de facturación
            </p>
        </div>
        <div class="col-md-4 text-end">
            <div class="text-muted">
                <i class="fas fa-calendar-alt" style="color: #06b6d4;"></i> 
                <span id="fecha-actual"></span>
            </div>
        </div>
    </div>
</div>

<!-- Tarjetas de estadísticas mejoradas -->
<div class="row g-4 mb-4">
    <!-- Total Facturas -->
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1">
                    <p class="text-muted mb-2 text-uppercase" style="font-size: 0.85rem; font-weight: 600; letter-spacing: 1px;">Total Facturas</p>
                    <h2 class="mb-0" style="color: #0891b2;">{{ total_facturas }}</h2>
                </div>
                <div class="stats-icon" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                    <i class="fas fa-file-invoice"></i>
                </div>
            </div>
            <a href="{% url 'facturacion:factura_lista' %}" class="text-decoration-none" style="color: #0891b2; font-weight: 600;">
                Ver todas <i class="fas fa-arrow-right ms-1"></i>
            </a>
        </div>
    </div>

    <!-- Total Facturado -->
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1">
                    <p class="text-muted mb-2 text-uppercase" style="font-size: 0.85rem; font-weight: 600; letter-spacing: 1px;">Total Facturado</p>
                    <h2 class="mb-0 text-success">₲ {{ total_facturado|floatformat:0 }}</h2>
                </div>
                <div class="stats-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <i class="fas fa-dollar-sign"></i>
                </div>
            </div>
            <span class="text-success" style="font-weight: 600;">
                <i class="fas fa-check-circle"></i> Facturas pagadas
            </span>
        </div>
    </div>

    <!-- Pendientes -->
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1">
                    <p class="text-muted mb-2 text-uppercase" style="font-size: 0.85rem; font-weight: 600; letter-spacing: 1px;">Pendientes</p>
                    <h2 class="mb-0 text-warning">{{ facturas_pendientes }}</h2>
                </div>
                <div class="stats-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
            <span class="text-warning" style="font-weight: 600;">
                <i class="fas fa-hourglass-half"></i> ₲ {{ monto_pendiente|floatformat:0 }}
            </span>
        </div>
    </div>

    <!-- Clientes -->
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1">
                    <p class="text-muted mb-2 text-uppercase" style="font-size: 0.85rem; font-weight: 600; letter-spacing: 1px;">Clientes</p>
                    <h2 class="mb-0" style="color: #6366f1;">{{ total_clientes }}</h2>
                </div>
                <div class="stats-icon" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                    <i class="fas fa-users"></i>
                </div>
            </div>
            <a href="{% url 'facturacion:cliente_lista' %}" class="text-decoration-none" style="color: #6366f1; font-weight: 600;">
                Ver todos <i class="fas fa-arrow-right ms-1"></i>
            </a>
        </div>
    </div>
</div>

<!-- Acciones Rápidas Mejoradas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card-modern">
            <div class="card-header">
                <h5 class="mb-0 text-white fw-bold">
                    <i class="fas fa-bolt"></i> Acciones Rápidas
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <a href="{% url 'facturacion:factura_crear' %}" class="btn btn-primary quick-action-btn w-100">
                            <i class="fas fa-plus-circle"></i>
                            <div>Nueva Factura</div>
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <a href="{% url 'facturacion:cliente_crear' %}" class="btn btn-success quick-action-btn w-100">
                            <i class="fas fa-user-plus"></i>
                            <div>Nuevo Cliente</div>
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <a href="{% url 'facturacion:factura_lista' %}" class="btn btn-info quick-action-btn w-100">
                            <i class="fas fa-list"></i>
                            <div>Ver Facturas</div>
                        </a>
                    </div>
                    {% if user.is_staff or user.is_superuser %}
                    <div class="col-lg-3 col-md-6">
                        <a href="{% url 'facturacion:timbrado_configurar' %}" class="btn btn-warning quick-action-btn w-100">
                            <i class="fas fa-stamp"></i>
                            <div>Configurar Timbrado</div>
                        </a>
                    </div>
                    {% else %}
                    <div class="col-lg-3 col-md-6">
                        <a href="/admin/" target="_blank" class="btn btn-secondary quick-action-btn w-100">
                            <i class="fas fa-cog"></i>
                            <div>Panel Admin</div>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Últimas Facturas -->
    <div class="col-lg-8">
        <div class="card-modern h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="text-white fw-bold"><i class="fas fa-file-invoice"></i> Últimas Facturas</span>
                <span class="badge bg-white text-primary badge-modern">{{ ultimas_facturas.count }}</span>
            </div>
            <div class="card-body p-0">
                {% if ultimas_facturas %}
                <div class="table-responsive">
                    <table class="table table-modern table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="text-white">Número</th>
                                <th class="text-white">Cliente</th>
                                <th class="text-white">Fecha</th>
                                <th class="text-white text-end">Total</th>
                                <th class="text-white text-center">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for factura in ultimas_facturas %}
                            <tr>
                                <td>
                                    <a href="{% url 'facturacion:factura_detalle' factura.pk %}" class="text-decoration-none fw-bold" style="color: #0891b2;">
                                        {{ factura.numero_factura }}
                                    </a>
                                </td>
                                <td class="fw-500">{{ factura.cliente.nombre|truncatewords:4 }}</td>
                                <td class="text-muted">{{ factura.fecha_emision|date:"d/m/Y" }}</td>
                                <td class="text-end fw-bold" style="color: #059669;">₲ {{ factura.total|floatformat:0 }}</td>
                                <td class="text-center">
                                    <span class="badge bg-{{ factura.get_estado_color }} badge-modern">
                                        {{ factura.get_estado_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-4x mb-3" style="color: #cbd5e1;"></i>
                    <p class="text-muted fw-500">No hay facturas registradas</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Top Clientes -->
    <div class="col-lg-4">
        <div class="card-modern h-100">
            <div class="card-header">
                <h5 class="mb-0 text-white fw-bold">
                    <i class="fas fa-star"></i> Top Clientes
                </h5>
            </div>
            <div class="card-body">
                {% if top_clientes %}
                    {% for cliente in top_clientes %}
                    <div class="client-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold" style="color: #0f172a;">{{ cliente.nombre|truncatewords:3 }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-file-invoice"></i> {{ cliente.total_facturas }} factura{{ cliente.total_facturas|pluralize }}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="fw-bold" style="color: #059669; font-size: 1.1rem;">
                                    ₲ {{ cliente.total_facturado|default:0|floatformat:0 }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x mb-3" style="color: #cbd5e1;"></i>
                        <p class="text-muted">No hay datos disponibles</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Estadísticas por Estado -->
{% if facturas_por_estado %}
<div class="row">
    <div class="col-12">
        <div class="card-modern">
            <div class="card-header">
                <h5 class="mb-0 text-white fw-bold">
                    <i class="fas fa-chart-pie"></i> Facturas por Estado
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-4">
                    {% for item in facturas_por_estado %}
                    <div class="col-md-4">
                        <div class="estado-card">
                            <h3>{{ item.cantidad }}</h3>
                            <p class="text-muted mb-2 fw-600 text-uppercase" style="font-size: 0.9rem; letter-spacing: 1px;">{{ item.estado }}</p>
                            <p class="mb-0 fw-bold" style="color: #059669; font-size: 1.2rem;">₲ {{ item.total|default:0|floatformat:0 }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Mostrar fecha actual
    document.addEventListener('DOMContentLoaded', function() {
        const fechaElement = document.getElementById('fecha-actual');
        const hoy = new Date();
        const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
        fechaElement.textContent = hoy.toLocaleDateString('es-ES', opciones);

        // Animación de contadores mejorada
        const counters = document.querySelectorAll('.stats-card h2');
        counters.forEach(counter => {
            const text = counter.textContent.trim();
            const hasSymbol = text.includes('₲');
            const finalValue = parseInt(text.replace(/[^0-9]/g, ''));
            
            if (!isNaN(finalValue) && finalValue > 0) {
                let currentValue = 0;
                const increment = finalValue / 40;
                const duration = 1500;
                const stepTime = duration / 40;
                
                counter.textContent = hasSymbol ? '₲ 0' : '0';
                
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        currentValue = finalValue;
                        clearInterval(timer);
                    }
                    
                    if (hasSymbol) {
                        counter.textContent = '₲ ' + Math.floor(currentValue).toLocaleString('es-PY');
                    } else {
                        counter.textContent = Math.floor(currentValue).toLocaleString('es-PY');
                    }
                }, stepTime);
            }
        });
    });
</script>
{% endblock %}
